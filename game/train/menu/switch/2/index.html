
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™ºè»Šãƒ™ãƒ«ã‚¹ã‚¤ãƒƒãƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 1. åŸºæœ¬è¨­å®šã¨èƒŒæ™¯ */
        body {
            font-family: 'Roboto', 'Noto Sans JP', sans-serif;
            text-align: center;
            background-color: #f8f9fa; 
            color: #3c4043; 
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: default;
            /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®é…ç½®ã‚’èª¿æ•´ã™ã‚‹ãŸã‚ã«flex-directionã‚’columnã«ã™ã‚‹ */
            flex-direction: column; 
            align-items: stretch; /* æˆ»ã‚‹ãƒªãƒ³ã‚¯ã‚’å·¦ç«¯ã«å¯„ã›ã‚‹ãŸã‚ */
        }
        /* ğŸ’¡ æˆ»ã‚‹ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« (å›ºå®šè§£é™¤ã€é€šå¸¸ã®ãƒ•ãƒ­ãƒ¼ã«é…ç½®) */
        #back-link-container {
            /* å›ºå®šã‚’è§£é™¤ã—ã€paddingã§ä½ç½®ã‚’å¾®èª¿æ•´ */
            position: relative; 
            padding: 10px 20px 0 20px; /* å·¦å³ã«ä½™ç™½ */
            z-index: 10; 
            background-color: transparent; 
            box-shadow: none; 
            width: 100%;
            box-sizing: border-box;
            order: -1; /* bodyã®å…ˆé ­ã«é…ç½® */
        }
        #back-link {
            display: inline-block;
            text-decoration: none;
            color: #007aff; /* Appleè¨­å®šé¢¨ã®é’è‰² */
            font-size: 1.1em;
            font-weight: 400;
            padding: 5px 10px; 
            transition: opacity 0.2s;
            float: left; /* å·¦å¯„ã› */
        }
        #back-link:hover {
            opacity: 0.7;
        }
        #back-link::before {
            content: 'ï¼œ'; /* æˆ»ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ */
            margin-right: 5px;
            font-weight: 600; /* çŸ¢å°ã‚’å¤ªã */
        }

        /* 2. ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            max-width: 800px;
            width: 90%; 
            /* ãƒªãƒ³ã‚¯ã®åˆ†ã€ä¸Šãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
            margin: 10px auto 20px auto; 
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
            transition: box-shadow 0.3s;
        }
        h1 {
            color: #1a73e8;
            font-size: 2.5em;
            font-weight: 500; 
            margin-bottom: 20px;
        }

        /* 3. æ“ä½œèª¬æ˜ãƒ‘ãƒãƒ« */
        .instructions {
            margin: 20px 0 30px 0;
            font-size: 1em;
            font-weight: 400;
            color: #5f6368;
            background-color: #e8f0fe;
            padding: 15px;
            border-radius: 8px; 
            text-align: left;
            border-left: 5px solid #1a73e8;
        }
        .instructions span {
            display: block;
            margin-bottom: 5px;
            line-height: 1.5;
        }
        .instructions strong {
            font-weight: 700;
            color: #1a73e8; 
        }
        /* 4. è¨­å®šé …ç›® */
        .setting-controls {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-top: 25px;
            padding: 15px 0;
            border-top: 1px dashed #dadce0; 
        }
        .control-group {
            margin: 15px 10px;
            text-align: left;
            flex-grow: 1;
            min-width: 200px;
        }
        /* ğŸ’¡ æ¥è¿‘è¨­å®šã‚¨ãƒªã‚¢ */
        .approach-settings-group {
            display: flex;
            justify-content: space-between;
            align-items: flex-end; 
            padding: 10px 0;
            margin-top: 5px; 
            margin-bottom: 20px; 
            border-bottom: 1px dashed #dadce0;
        }
        .approach-settings-group .control-group {
            flex-basis: 70%;
            margin: 0;
        }
        #approach-toggle-button { 
            padding: 12px 20px; 
            font-size: 16px;
            font-weight: 500;
            color: white;
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            transition: background-color 0.3s, box-shadow 0.3s;
            min-width: 100px;
            margin-left: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            height: 48px; 
            box-sizing: border-box;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #3c4043;
            font-size: 0.9em;
        }
        select {
            padding: 12px 16px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            background-color: #ffffff; 
            color: #3c4043;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            appearance: none; 
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231a73e8'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            transition: border-color 0.2s, box-shadow 0.2s;
            height: 48px; 
        }
        select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 1px #1a73e8;
            outline: none;
        }
        /* è¨­å®šå¤‰æ›´æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .setting-controls .changed-setting {
            animation: pulse-border 0.5s ease-out;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(26, 115, 232, 0); }
            100% { box-shadow: none; }
        }
        /* ğŸ’¡ GIFè¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #approach-board {
            width: 80%;
            max-width: 600px;
            height: auto;
            margin: 20px auto 10px auto; 
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s;
            cursor: default; 
            opacity: 1; 
        }
        #approach-note {
            display: block;
            margin-bottom: 5px; 
            font-size: 1.1em;
            color: #5f6368;
            font-weight: 500;
            opacity: 1 !important; 
        }
        /* 5. é‹è¡ŒçŠ¶æ…‹ãƒœã‚¿ãƒ³ã¨ã‚¹ãƒãƒ›ç”¨ON/OFFãƒœã‚¿ãƒ³ */
        .button-container {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #toggle-button {
            padding: 15px 30px;
            font-size: 20px;
            font-weight: 500;
            color: white;
            border: none;
            border-radius: 28px; 
            cursor: default;
            transition: background-color 0.3s, box-shadow 0.3s;
            pointer-events: none;
            min-width: 250px;
            box-shadow: 0 2px 5px 0 rgba(0,0,0,0.26);
            margin-bottom: 15px;
        }
        /* ã‚¹ãƒãƒ›/ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ãƒœã‚¿ãƒ³ */
        .mobile-buttons {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .mobile-buttons button {
            padding: 12px 25px;
            font-size: 18px;
            font-weight: 500;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        #mobile-on-button {
            background-color: #4CAF50; 
            color: white;
        }
        #mobile-off-button {
            background-color: #D32F2F; 
            color: white;
        }
    </style>
</head>
<body>
    
    <div id="back-link-container">
        <a id="back-link" href="https://symphony100.github.io/symphony/game/train/menu/switch/home/b/">å…ƒã®ã‚µã‚¤ãƒˆã«æˆ»ã‚‹</a>
    </div>

    <div class="container">
        <h1>ç™ºè»Šãƒ™ãƒ«ã‚¹ã‚¤ãƒƒãƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>

        
        <div class="instructions">
            <span>
                ã€PCãƒ¦ãƒ¼ã‚¶ãƒ¼ã€‘å³ã‚¯ãƒªãƒƒã‚¯ã‚’æŠ¼ã—ç¶šã‘ã‚‹ã¨ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ãŒæµã‚Œã€é›¢ã™ã¨åœæ­¢ã—ã¾ã™ã€‚<br>
                Pointer Lock APIã«ã‚ˆã‚Šã€å³ã‚¯ãƒªãƒƒã‚¯ä¸­ã¯ã‚«ãƒ¼ã‚½ãƒ«ãŒéè¡¨ç¤ºã«ãªã‚Šã€å›ºå®šã•ã‚Œã¾ã™ã€‚<br>
                ESCã‚­ãƒ¼ã‚’æŠ¼ã™ã¨ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚Œã¾ã™ã€‚
            </span>
            <hr style="border: 0; border-top: 1px solid #c8d1e2; margin: 10px 0;">
            <span>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ã§è¨­å®šã‚’ç´ æ—©ãå¤‰æ›´ã§ãã¾ã™ã€‚</span>
            <span>ï¼‘ï¼šç™ºè»Šãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼å¤‰æ›´ â†’ <strong id="melody-current-key">water crown</strong></span>
            <span>ï¼’ï¼šå‹•ä½œãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ â†’ <strong id="mode-current-key">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</strong></span>
            <span>ï¼“ï¼šæˆ¸é–‰ã‚æ”¾é€å¤‰æ›´ â†’ <strong id="announcement-current-key">ãƒ‘ã‚¿ãƒ¼ãƒ³ ï¼‘</strong></span>
        </div>

        
        <img 
            id="approach-board" 
            src="https://raw.githubusercontent.com/ssmn93/depart-melody/main/approach/%E7%BE%BD%E7%94%B0%E7%A9%BA%E6%B8%AF%E7%AC%AC%E4%B8%89%E3%82%BF%E3%83%BC%E3%83%9F%E3%83%8A%E3%83%AB_1%E7%95%AA_%E5%88%B0%E7%9D%80%E5%89%8D.gif" 
            alt="é§…ã®é›»å…‰æ²ç¤ºæ¿" 
        />
        <span id="approach-note">ç¾åœ¨ã®æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼: äº¬æ€¥ï¼ˆãƒ‘ãƒ—ãƒªã‚«ï¼‰</span>
        
        <div class="approach-settings-group">
            <div class="control-group">
                <label for="approach-melody-select">æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼</label>
                <select id="approach-melody-select">
                    </select>
            </div>
            <button id="approach-toggle-button" style="background-color: #4CAF50;">æ¥è¿‘ ON</button>
        </div>
        
        
        <div class="setting-controls">
            <div class="control-group">
                <label for="melody-select">ç™ºè»Šãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼</label>
                <select id="melody-select">
                    <optgroup label="æ±äº¬ãƒ¡ãƒˆãƒ­">
                        <option value="https://symphony100.github.io/symphony/game/train/menu/switch/2/å–¶å›£ãƒ–ã‚¶ãƒ¼.mp3">å–¶å›£ãƒ–ã‚¶ãƒ¼</option>
                    </optgroup>
                    <optgroup label="éƒ½å–¶åœ°ä¸‹é‰„">
                        <option value="ç´ ç›´ãªå¿ƒ.mp3">ç´ ç›´ãªå¿ƒ</option>
                        <option value="ãƒ¡ãƒ­ãƒ†ã‚™ã‚£ãƒ¼.mp3">ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼</option>
                        <option value="éŸ³ç„¡å·ã®æµã‚ŒA.mp3">éŸ³ç„¡å·ã®æµã‚ŒA</option>
                        <option value="éŸ³ç„¡å·ã®æµã‚ŒB.mp3">éŸ³ç„¡å·ã®æµã‚ŒB</option>
                    </optgroup>                    
                    <optgroup label="æ±æ­¦é‰„é“">
                        <option value="https://symphony100.github.io/symphony/game/train/menu/switch/Step by step.mp3">Step by step</option>
                    </optgroup>
                </select>
            </div>
            <div class="control-group">
                <label for="mode-select">å‹•ä½œãƒ¢ãƒ¼ãƒ‰</label>
                <select id="mode-select">
                    <option value="normal">é€šå¸¸</option>
                    <option value="tachikawa">ç«‹å·å¼</option>
                </select>
            </div>
            <div class="control-group">
                <label for="announcement-select">æˆ¸é–‰æ”¾é€</label>
                <select id="announcement-select">
                    <option value="none">ãªã—</option>
                    <option value="https://symphony100.github.io/symphony/game/train/menu/switch/stop-1.mp3">ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‘ï¼ˆå¥³å£°ï¼‰</option>
                    <option value="https://symphony100.github.io/symphony/game/train/menu/switch/stop-2.mp3">ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼’ï¼ˆç”·å£°ï¼‰</option>
                    <option value="https://symphony100.github.io/symphony/game/train/menu/switch/stop-3.mp3">ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼“ï¼ˆæ´¥ç”°è‹±æ²»ï¼‰</option>
                    <option value="https://symphony100.github.io/symphony/game/train/menu/switch/ã‚Šã‚“ã‹ã„å¥³å£°2ç•ª.mp3">ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼”ï¼ˆæ±äº¬è‡¨æµ·é«˜é€Ÿé‰„é“å¥³å£°ï¼‰</option>
                    <option value="https://symphony100.github.io/symphony/game/train/menu/switch/ã‚Šã‚“ã‹ã„ç”·å£°1ç•ª.mp3">ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼•ï¼ˆæ±äº¬è‡¨æµ·é«˜é€Ÿé‰„é“ç”·æ€§å£°ï¼‰</option>
                    <option value="https://symphony100.github.io/symphony/game/train/menu/switch/å·Œæ ¹å‹å¥³å£°.mp3">ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼–ï¼ˆå·Œæ ¹å‹å¥³å£°ï¼‰</option>
                    <option value="https://symphony100.github.io/symphony/game/train/menu/switch/å·Œæ ¹å‹ç”·å£°.mp3">ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼—ï¼ˆå·Œæ ¹å‹ç”·å£°ï¼‰</option>
                    <option value="https://symphony100.github.io/symphony/game/train/menu/switch/tobu-stop-1.mp3">ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼˜ï¼ˆæ±æ­¦é‰„é“ï¼‰</option>
                </select>
            </div>
        </div>
        
        <div class="button-container">
            <button id="toggle-button" style="background-color: #4CAF50;">OFF</button>
            <div class="mobile-buttons">
                <button id="mobile-on-button">ON</button>
                <button id="mobile-off-button">OFF</button>
            </div>
        </div>
    </div>
    
    <audio id="departure-melody" preload="auto" loop></audio>    
    <audio id="announcement" src="https://symphony100.github.io/symphony/game/train/menu/switch/stop-1.mp3" preload="auto"></audio>    
    <audio id="return-sound" src="https://symphony100.github.io/symphony/game/train/menu/switch/train-stop.mp3" preload="auto"></audio> 
    <audio 
        id="approach-melody" 
        src="" 
        preload="auto"
    ></audio>
    
    <script>
        // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
        const HANEDA_GIF_SRC = {
            before: "https://raw.githubusercontent.com/ssmn93/depart-melody/main/approach/%E7%BE%BD%E7%94%B0%E7%A9%BA%E6%B8%AF%E7%AC%AC%E4%B8%89%E3%82%BF%E3%83%BC%E3%83%9F%E3%83%8A%E3%83%AB_1%E7%95%AA_%E5%88%B0%E7%9D%80%E5%89%8D.gif",
            after: "https://raw.githubusercontent.com/ssmn93/depart-melody/main/approach/%E7%BE%BD%E7%94%B0%E7%A9%BA%E6%B8%AF%E7%AC%AC%E4%B8%89%E3%82%BF%E3%83%BC%E3%83%9F%E3%83%8A%E3%83%AB_1%E7%95%AA_%E6%8E%A5%E8%BF%91%E4%B8%AD.gif"
        };
        
        // --- ğŸ’¡ ä¿®æ­£ç®‡æ‰€ï¼šAPPROACH_MELODY_DATAã®å®šç¾©ã‚’ä¿®æ­£ ---
        // æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ã®éŸ³æºãŒç½®ã‹ã‚Œã¦ã„ã‚‹ãƒ™ãƒ¼ã‚¹URL
        const APPROACH_MELODY_BASE_URL = "https://symphony100.github.io/symphony/game/train/menu/switch/"; 
        
        const APPROACH_MELODY_DATA = {
            '1': { name: "1", melody: APPROACH_MELODY_BASE_URL + "1.mp3" },
            '2': { name: "2", melody: APPROACH_MELODY_BASE_URL + "2.mp3" },
            '3': { name: "3", melody: APPROACH_MELODY_BASE_URL + "3.mp3" },
            '4': { name: "4", melody: APPROACH_MELODY_BASE_URL + "4.mp3" },
            '5': { name: "5", melody: APPROACH_MELODY_BASE_URL + "5.mp3" },
            '6': { name: "6", melody: APPROACH_MELODY_BASE_URL + "6.mp3" },
            '7': { name: "7", melody: APPROACH_MELODY_BASE_URL + "7.mp3" },
            '8': { name: "8", melody: APPROACH_MELODY_BASE_URL + "8.mp3" },
            '9': { name: "9", melody: APPROACH_MELODY_BASE_URL + "9.mp3" },
            '10': { name: "10", melody: APPROACH_MELODY_BASE_URL + "10.mp3" },
            '11': { name: "11", melody: APPROACH_MELODY_BASE_URL + "11.mp3" },
            '12': { name: "12", melody: APPROACH_MELODY_BASE_URL + "12.mp3" } 
        };
        // ----------------------------------------------------
        
        // --- å¤‰æ•°å®šç¾© ---
        let isPlaying = false; 
        let isRightMouseButtonDown = false; 
        let tachikawaStopListener = null; 
        let isMobilePlay = false; 
        let isApproachPlaying = false; 
        let isApproachEnabled = true; // åˆæœŸå€¤

        // --- è¦ç´ ã®å–å¾— ---
        const melody = document.getElementById("departure-melody");
        const announcement = document.getElementById("announcement");
        const returnSound = document.getElementById("return-sound");
        const toggleButton = document.getElementById("toggle-button");
        const melodySelect = document.getElementById("melody-select");
        const modeSelect = document.getElementById("mode-select");
        const announcementSelect = document.getElementById("announcement-select");
        const mobileOnButton = document.getElementById("mobile-on-button");
        const mobileOffButton = document.getElementById("mobile-off-button");
        const approachBoard = document.getElementById("approach-board"); 
        const approachMelody = document.getElementById("approach-melody"); 
        
        const approachMelodySelect = document.getElementById("approach-melody-select");
        const approachToggleButton = document.getElementById("approach-toggle-button");

        // --- åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ ---
        const melodyKeyDisplay = document.getElementById("melody-current-key");
        const modeKeyDisplay = document.getElementById("mode-current-key");
        const announcementKeyDisplay = document.getElementById("announcement-current-key");

        const melodyOptions = Array.from(melodySelect.options).map(opt => opt.value);
        let currentMelodyIndex = 0; 
        const modeOptions = Array.from(modeSelect.options).map(opt => opt.value);
        let currentModeIndex = 0;
        const announcementOptions = Array.from(announcementSelect.options).map(opt => opt.value);
        let currentAnnouncementIndex = 0;
        
        // æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£é¸æŠè‚¢ã®å‹•çš„ç”Ÿæˆã¨åˆæœŸè¨­å®š
        function initializeApproachSelect() {
            // ğŸ’¡ åˆæœŸè¡¨ç¤ºã®ä¿®æ­£: æœ€åˆã¯APPROACH_MELODY_DATAã®æœ€åˆã®é …ç›®ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            const firstApproachKey = Object.keys(APPROACH_MELODY_DATA)[0];
            const firstApproachData = APPROACH_MELODY_DATA[firstApproachKey];

            for (const key in APPROACH_MELODY_DATA) {
                const data = APPROACH_MELODY_DATA[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = data.name;
                approachMelodySelect.appendChild(option);
            }
            
            // åˆæœŸçŠ¶æ…‹ã®æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById("approach-note").textContent = 
                `ç¾åœ¨ã®æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼: ${firstApproachData.name}`;
        }
        
        // --- ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ç„¡åŠ¹åŒ–ã®ãŸã‚ã®å±¥æ­´æ“ä½œ ---
        function disableBrowserBack() {
            // ç¾åœ¨ã®URLã§æ–°ã—ã„å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆ
            history.pushState(null, null, location.href);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã«ã€å†åº¦æ–°ã—ã„å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆã—ã€äº‹å®Ÿä¸Šä½•ã‚‚ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
            window.addEventListener('popstate', function (event) {
                history.pushState(null, null, location.href);
                // é€šçŸ¥ã¯è¡Œã„ã¾ã›ã‚“ã€‚
            });
            
             // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ã§ã®èª¤æ“ä½œé˜²æ­¢ (ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ç›£è¦–)
             let touchstartX = 0;
             let touchendX = 0;
             
             document.addEventListener('touchstart', function(event) {
                // ã‚·ãƒ³ã‚°ãƒ«ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹
                if (event.touches.length === 1) {
                    touchstartX = event.touches[0].screenX;
                }
             }, false);
             
             document.addEventListener('touchend', function(event) {
                // event.changedTouches[0]ã¯æŒ‡ã‚’é›¢ã—ãŸä½ç½®
                touchendX = event.changedTouches[0].screenX;
                handleGesture();
             }, false);

             function handleGesture() {
                // å·¦ã‹ã‚‰å³ã¸ã®ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæˆ»ã‚‹å‹•ä½œï¼‰ã‚’æ¤œçŸ¥ã€‚å±¥æ­´æ“ä½œã§ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚
                const swipeThreshold = 50; 
                if (touchendX > touchstartX + swipeThreshold) {
                    // ã“ã“ã§ã®æ˜ç¤ºçš„ãªã‚¤ãƒ™ãƒ³ãƒˆé˜»æ­¢ã¯ã€ä»–ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¦¨ã’ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚è¡Œã„ã¾ã›ã‚“ã€‚
                }
             }
        }

        // --- è¨­å®šä¿å­˜/èª­ã¿è¾¼ã¿é–¢æ•° ---
        function saveSettings() {
            try {
                const settings = {
                    melody: melodySelect.value,
                    mode: modeSelect.value,
                    announcement: announcementSelect.value,
                    approachMelody: approachMelodySelect.value,
                    approachEnabled: isApproachEnabled 
                };
                localStorage.setItem('trainSimulatorSettings', JSON.stringify(settings));
            } catch (e) {
                console.error("localStorageã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
            }
        }
        
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('trainSimulatorSettings');
                
                // æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£é¸æŠè‚¢ã®ã‚­ãƒ¼ã®é…åˆ—ã‚’å–å¾—
                const approachKeys = Object.keys(APPROACH_MELODY_DATA);
                const defaultApproachKey = approachKeys.length > 0 ? approachKeys[0] : null;

                if (!savedSettings) {
                    // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ã€åˆæœŸè¨­å®šã‚’é©ç”¨ã—ã€ä¿å­˜ã™ã‚‹
                    if (defaultApproachKey) {
                        approachMelodySelect.value = defaultApproachKey;
                    }
                    updateApproachMelodySource(false);
                    updateApproachToggleButton(false);
                    handleSettingChange(null, false);
                    saveSettings(); // åˆæœŸè¨­å®šã‚’ä¿å­˜
                    return;
                }

                const settings = JSON.parse(savedSettings);

                // 1. å„Selectè¦ç´ ã®å€¤ã‚’å¾©å…ƒ
                melodySelect.value = settings.melody || melodySelect.options[0].value;
                modeSelect.value = settings.mode || modeSelect.options[0].value;
                announcementSelect.value = settings.announcement || announcementSelect.options[0].value;
                
                // æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ã¯ã‚­ãƒ¼ã§æ‰±ã†ãŸã‚ã€APPROACH_MELODY_DATAã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                if (settings.approachMelody && APPROACH_MELODY_DATA[settings.approachMelody]) {
                    approachMelodySelect.value = settings.approachMelody;
                } else if (defaultApproachKey) {
                    approachMelodySelect.value = defaultApproachKey;
                }

                // 2. çŠ¶æ…‹å¤‰æ•°ã®å¾©å…ƒ
                isApproachEnabled = settings.approachEnabled === true; // booleanã¨ã—ã¦å¾©å…ƒ

                // 3. Selectè¦ç´ ã®å¤‰æ›´ã‚’é©ç”¨ (ã“ã‚Œã«ã‚ˆã‚ŠéŸ³æºã®srcã‚„ã‚­ãƒ¼è¡¨ç¤ºãŒæ›´æ–°ã•ã‚Œã‚‹)
                handleSettingChange(null, false); // ç™ºè»Šãƒ¡ãƒ­ãƒ‡ã‚£ã€ãƒ¢ãƒ¼ãƒ‰ã€æˆ¸é–‰æ”¾é€ã®æ›´æ–°
                updateApproachMelodySource(false); // æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ã®æ›´æ–° (éŸ³æºã¨note)
                updateApproachToggleButton(false); // æ¥è¿‘ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
                
                // 4. æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ã®å†ç”Ÿã‚’é–‹å§‹
                if (isApproachEnabled) {
                    playApproachMelody();
                }

            } catch (e) {
                console.error("localStorageã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
                // èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã‚‚ã€æœ€ä½é™ã®åˆæœŸåŒ–ã¯è¡Œã†
                updateApproachMelodySource(false);
                updateApproachToggleButton(false);
                handleSettingChange(null, false);
            }
        }
        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
        function updateIndicesFromSelects() {
            currentMelodyIndex = melodySelect.selectedIndex;
            currentModeIndex = modeSelect.selectedIndex;
            currentAnnouncementIndex = announcementSelect.selectedIndex;
        }

        function updateKeyDisplay() {
            melodyKeyDisplay.textContent = melodySelect.options[currentMelodyIndex].textContent;
            modeKeyDisplay.textContent = modeSelect.options[currentModeIndex].textContent;
            announcementKeyDisplay.textContent = announcementSelect.options[currentAnnouncementIndex].textContent;
        }
        
        // æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ã®ON/OFFãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–° 
        function updateApproachToggleButton(showNotify = false) { 
            if (isApproachEnabled) {
                approachToggleButton.textContent = "æ¥è¿‘ ON";
                approachToggleButton.style.backgroundColor = "#4CAF50";
                // ğŸ’¡ GIFã‚‚ONçŠ¶æ…‹ï¼ˆåˆ°ç€å‰ï¼‰ã®ã‚‚ã®ã«æ›´æ–°
                approachBoard.src = HANEDA_GIF_SRC.before; 
            } else {
                approachToggleButton.textContent = "æ¥è¿‘ OFF";
                approachToggleButton.style.backgroundColor = "#D32F2F";
                // ğŸ’¡ OFFçŠ¶æ…‹ã§ã¯GIFã‚’åœæ­¢ã•ã›ã‚‹ã‹ã€åœæ­¢çŠ¶æ…‹ã®ç”»åƒã«åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆä»Šå›ã¯å‰è€…ã®å‡¦ç†ã¯ä¸è¦ã ãŒã€GIFã¯åˆ°ç€å‰ã§åœæ­¢ã—ã¦ã„ã‚‹ã‚‚ã®ã¨ã™ã‚‹ï¼‰
                stopApproachMelody();
            }
        }

        // æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ã®éŸ³æºã¨æ³¨æ„æ›¸ãã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateApproachMelodySource(showNotify = false) { 
            const selectedKey = approachMelodySelect.value;
            const data = APPROACH_MELODY_DATA[selectedKey];
            
            // data.melody ãŒæ—¢ã«å®Œå…¨ãªURLã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€ã“ã®ã¾ã¾ä½¿ç”¨ã™ã‚‹

            if (isApproachPlaying) {
                stopApproachMelody();
            }
            
            // ğŸ’¡ éŸ³æºURLã‚’ç›´æ¥è¨­å®š
            approachMelody.src = data.melody; 
            
            document.getElementById("approach-note").textContent = 
                `ç¾åœ¨ã®æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼: ${data.name}`;

            // éŸ³æºãŒã‚ã‚‹å ´åˆã€æ¥è¿‘ãŒæœ‰åŠ¹ãªã‚‰å†ç”Ÿã‚’é–‹å§‹
            if (isApproachEnabled && data.melody !== '') {
                playApproachMelody();
            } else if (data.melody === '' && isApproachEnabled) {
                // éŸ³æºãŒãªã„å ´åˆã€æœ‰åŠ¹ã§ã‚‚å†ç”Ÿã¯ã—ãªã„
                stopApproachMelody();
            }
            saveSettings(); // è¨­å®šå¤‰æ›´æ™‚ã«ä¿å­˜
        }

        // ç™ºè»Šãƒ¡ãƒ­ãƒ‡ã‚£/ãƒ¢ãƒ¼ãƒ‰/æ”¾é€ã®è¨­å®šå¤‰æ›´é–¢æ•°
        function handleSettingChange(event, showNotify = false) { 
            if (tachikawaStopListener) {
                melody.removeEventListener('ended', tachikawaStopListener);
                tachikawaStopListener = null;
            }

            if (announcementSelect.value === 'none') {
                announcement.src = '';
            } else {
                announcement.src = announcementSelect.value;
            }
            
            melody.src = melodySelect.value;

            updateIndicesFromSelects();
            updateKeyDisplay();
            
            const selectElement = event ? event.target : null;
            if (selectElement) {
                const parentGroup = selectElement.closest('.control-group');
                parentGroup.classList.remove('changed-setting');
                void parentGroup.offsetWidth; 
                parentGroup.classList.add('changed-setting');
            }

            if (isPlaying) {
                melody.pause();
                melody.currentTime = 0;
                melody.loop = true;
                if (!isMobilePlay) {
                    melody.play().catch(error => {
                        console.error("ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼å†ç”Ÿã‚¨ãƒ©ãƒ¼:", error);
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚é€šçŸ¥ã¯è¡Œã„ã¾ã›ã‚“
                    });
                }
            }
            saveSettings(); // è¨­å®šå¤‰æ›´æ™‚ã«ä¿å­˜
        }
        
        // --- æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ã®å†ç”Ÿ/åœæ­¢é–¢æ•° ---
        
        function playApproachMelody() {
            // ğŸ’¡ approachMelody.src ãŒç©ºã®å ´åˆã¯å†ç”Ÿã—ãªã„
            if (!isApproachEnabled || approachMelody.src === '' || isPlaying || isApproachPlaying) return;

            isApproachPlaying = true;
            // ğŸ’¡ GIFã‚’ã€Œæ¥è¿‘ä¸­ã€ã®ã‚‚ã®ã«åˆ‡ã‚Šæ›¿ãˆ
            approachBoard.src = HANEDA_GIF_SRC.after; 
            approachMelody.loop = true;
            approachMelody.currentTime = 0; 
            
            approachMelody.play().catch(error => {
                console.error("æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼å†ç”Ÿã‚¨ãƒ©ãƒ¼:", error);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€å†ç”Ÿã‚’åœæ­¢ã—ã€è¨­å®šã‚’OFFã«ã™ã‚‹
                isApproachEnabled = false;
                updateApproachToggleButton(false);
                stopApproachMelody();
            });
        }
        
        function stopApproachMelody() {
            if (!isApproachPlaying) return;
            
            isApproachPlaying = false;
            // ğŸ’¡ GIFã‚’ã€Œåˆ°ç€å‰ã€ã®ã‚‚ã®ã«åˆ‡ã‚Šæ›¿ãˆ
            approachBoard.src = HANEDA_GIF_SRC.before; 
            approachMelody.loop = false;
            approachMelody.pause();
            approachMelody.currentTime = 0;
        }

        // æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ON/OFFã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•° (ãƒœã‚¿ãƒ³å°‚ç”¨)
        function toggleApproachEnabled() {
            isApproachEnabled = !isApproachEnabled;
            
            if (isApproachEnabled) {
                playApproachMelody();
            } else {
                stopApproachMelody();
            }

            updateApproachToggleButton(false);
            saveSettings(); // çŠ¶æ…‹å¤‰æ›´æ™‚ã«ä¿å­˜
        }

        // --- æ—¢å­˜æ©Ÿèƒ½ï¼šç™ºè»Šãƒ¡ãƒ­ãƒ‡ã‚£ã®æ“ä½œé–¢æ•° ---
        
        function playMelody() {
            if (tachikawaStopListener) {
                melody.removeEventListener('ended', tachikawaStopListener);
                tachikawaStopListener = null;
            }
            
            if (isApproachPlaying) {
                // ğŸ’¡ ç™ºè»Šãƒ¡ãƒ­ãƒ‡ã‚£å†ç”Ÿä¸­ã¯æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ã‚’åœæ­¢
                stopApproachMelody();
            }

            returnSound.currentTime = 0;
            returnSound.play();                        
            
            melody.src = melodySelect.value;
            melody.currentTime = 0;
            melody.loop = true;
            melody.play().catch(error => {
                console.error("ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼å†ç”Ÿã‚¨ãƒ©ãƒ¼:", error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚é€šçŸ¥ã¯è¡Œã„ã¾ã›ã‚“
            });

            isPlaying = true;
            toggleButton.textContent = isMobilePlay ? "ON (å†ç”Ÿä¸­)" : "ON (ãƒ›ãƒ¼ãƒ«ãƒ‰ä¸­ / ã‚«ãƒ¼ã‚½ãƒ«ãƒ­ãƒƒã‚¯ä¸­)";
            toggleButton.style.backgroundColor = "#D32F2F"; 
            toggleButton.style.boxShadow = "0 4px 6px rgba(211, 47, 47, 0.4)";
        }

        function stopMelodyImmediately() {
            if (!isPlaying) return;

            melody.pause();
            melody.currentTime = 0;                        

            if (announcementSelect.value !== 'none') {
                announcement.src = announcementSelect.value;
                announcement.currentTime = 0;
                announcement.play(); 
            }

            isPlaying = false;
            toggleButton.textContent = "OFF (å¾…æ©Ÿä¸­)";
            toggleButton.style.backgroundColor = "#4CAF50"; 
            toggleButton.style.boxShadow = "0 2px 5px 0 rgba(0,0,0,0.26)";
            isMobilePlay = false;
            
            if (isApproachEnabled) {
                // ğŸ’¡ ç™ºè»Šãƒ¡ãƒ­ãƒ‡ã‚£åœæ­¢å¾Œã€æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ã‚’å†é–‹
                updateApproachMelodySource(false); // ã“ã‚Œã§æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ã®srcãŒè¨­å®šã•ã‚Œã€playApproachMelody()ãŒå‘¼ã°ã‚Œã‚‹
            }
        }

        function offSignalTachikawa() {
            if (!isPlaying || tachikawaStopListener) return;

            if (announcementSelect.value !== 'none') {
                announcement.src = announcementSelect.value;
                announcement.currentTime = 0;
                announcement.play(); 
            }

            melody.loop = false;
            toggleButton.textContent = "OFF (ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼çµ‚äº†å¾…ã¡)";
            toggleButton.style.backgroundColor = "#FFC107"; 
            toggleButton.style.boxShadow = "0 4px 6px rgba(255, 193, 7, 0.4)";

            tachikawaStopListener = () => {
                melody.removeEventListener('ended', tachikawaStopListener);
                tachikawaStopListener = null;                                
                melody.pause();
                melody.currentTime = 0;                                
                isPlaying = false;
                toggleButton.textContent = "OFF (å¾…æ©Ÿä¸­)";
                toggleButton.style.backgroundColor = "#4CAF50";
                toggleButton.style.boxShadow = "0 2px 5px 0 rgba(0,0,0,0.26)";
                isMobilePlay = false;

                if (isApproachEnabled) {
                    // ğŸ’¡ ç™ºè»Šãƒ¡ãƒ­ãƒ‡ã‚£çµ‚äº†å¾Œã€æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ã‚’å†é–‹
                    updateApproachMelodySource(false); 
                }
            };                        
            melody.addEventListener('ended', tachikawaStopListener);
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        
        melodySelect.addEventListener('change', handleSettingChange);
        modeSelect.addEventListener('change', handleSettingChange);
        announcementSelect.addEventListener('change', handleSettingChange);

        // ğŸ’¡ æ¥è¿‘ãƒ¡ãƒ­ãƒ‡ã‚£ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã€éŸ³æºã¨è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
        approachMelodySelect.addEventListener('change', () => updateApproachMelodySource(false)); 
        approachToggleButton.addEventListener('click', toggleApproachEnabled);

        // --- ãã®ä»–ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰/ãƒã‚¦ã‚¹/ãƒ¢ãƒã‚¤ãƒ«æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã— ---
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            let selectElement = null;
            let changed = false;

            if (e.key === '1') {
                currentMelodyIndex = (currentMelodyIndex + 1) % melodyOptions.length;
                melodySelect.value = melodyOptions[currentMelodyIndex];
                selectElement = melodySelect;
                changed = true;
                e.preventDefault();
            } else if (e.key === '2') {
                currentModeIndex = (currentModeIndex + 1) % modeOptions.length;
                modeSelect.value = modeOptions[currentModeIndex];
                selectElement = modeSelect;
                changed = true;
                e.preventDefault();
            } else if (e.key === '3') {
                currentAnnouncementIndex = (currentAnnouncementIndex + 1) % announcementOptions.length;
                announcementSelect.value = announcementOptions[currentAnnouncementIndex];
                selectElement = announcementSelect;
                changed = true;
                e.preventDefault();
            }

            if (changed && selectElement) {
                handleSettingChange({ target: selectElement }, false); 
            }

            if (e.key === 'Enter') {
                if (isPlaying) {
                    const mode = modeSelect.value;
                    if (mode === 'tachikawa') {
                        offSignalTachikawa();
                    } else {
                        stopMelodyImmediately();
                    }
                } else {
                    playMelody();
                    isMobilePlay = false; 
                }
                e.preventDefault();
            }
        });

        document.addEventListener('mousedown', function(e) {
            if (e.button === 2) {
                if (!isPlaying) {
                    isMobilePlay = false; 
                    playMelody();
                }
                isRightMouseButtonDown = true;
                e.preventDefault();
                if (document.pointerLockElement !== document.body) {
                    document.body.requestPointerLock().catch(err => {
                        console.warn("Pointer Lockã®è¦æ±‚ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚", err);
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚é€šçŸ¥ã¯è¡Œã„ã¾ã›ã‚“
                    });
                }
            }
        });

        document.addEventListener('mouseup', function(e) {
            if (e.button === 2) {
                if (isPlaying) {
                    const mode = modeSelect.value;
                    if (mode === 'tachikawa') {
                        offSignalTachikawa();
                    } else {
                        stopMelodyImmediately();
                    }
                }
                isRightMouseButtonDown = false;
                document.exitPointerLock();
            }
        });

        document.addEventListener('contextmenu', function(e) {
            e.preventDefault(); 
        });

        mobileOnButton.addEventListener('click', function() {
            if (!isPlaying) {
                isMobilePlay = true;
                playMelody();
            }
        });

        mobileOffButton.addEventListener('click', function() {
            if (isPlaying) {
                const mode = modeSelect.value;
                if (mode === 'tachikawa') {
                    offSignalTachikawa();
                } else {
                    stopMelodyImmediately();
                }
                isMobilePlay = false;
            }
        });

        // èµ·å‹•æ™‚ã®åˆæœŸåŒ–å‡¦ç†
        initializeApproachSelect();
        // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã‚€
        loadSettings();
        // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–
        disableBrowserBack();
    </script>
</body>
</html>
