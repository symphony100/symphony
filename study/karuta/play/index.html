<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<link rel="icon" type="image/x-icon" href="icon.png">
<meta name="keywords" content="ã‹ã‚‹ãŸ,ç™¾äººä¸€é¦–,æš—è¨˜,å›½èª,å¯¾ç­–">
<meta name="description" content="ç™¾äººä¸€é¦–ã‚’è¦šãˆã‚ˆã†ï¼">
<meta property="og:title" content="ç™¾äººä¸€é¦–">
<meta property="og:description" content="ç™¾äººä¸€é¦–ã‚’è¦šãˆã‚ˆã†ï¼">
<meta property="og:image" content="https://symphony100.github.io/symphony/study/karuta/icon.png">
<meta property="og:url" content="https://symphony100.github.io/symphony/study/karuta/">
<meta property="og:type" content="website">
<title>ç™¾äººä¸€é¦–</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho+B1&family=Noto+Serif+JP:wght=400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">
<style>
/* --- ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« --- */
body {  
  margin:0; 
  min-height:100vh; 
  display:flex; 
  justify-content:center; 
  align-items:center;  
  background:url('tatami.png') center/cover no-repeat fixed;  
  font-family:"Yuji Syuku","Shippori Mincho B1",serif;
  /* â˜…ä¿®æ­£: ã‚¿ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æº–å‚™ */
  transition: transform 0.1s; 
}

.container {   
  display:flex; 
  align-items:center; 
  justify-content:center; 
  gap:20px; 
  width:100%; 
  min-height:100vh; 
  padding: 20px 0; 
  box-sizing: border-box; 
}
.nav-btn {  background: rgba(47,93,80,0.9); color:white; border:none;  border-radius:50%; width:48px; height:48px; font-size:1.5rem;  cursor:pointer; display:flex; align-items:center; justify-content:center;  transition: background 0.2s; user-select:none;}.nav-btn:active { background: rgba(30,60,50,0.9); }

/* --- ã‚«ãƒ¼ãƒ‰æœ¬ä½“ --- */
.card {  
  width:min(80vw,380px); height:min(80vh,520px);  
  background:#fffef8; border:6px solid #2f5d50; border-radius:6px;  
  box-shadow:6px 8px 18px rgba(0,0,0,0.35);  
  display:flex; flex-direction: row-reverse; 
  justify-content:center; align-items:center; gap:24px; padding:18px;  
  position:relative; box-sizing:border-box; overflow:hidden;  
  will-change: transform, opacity; 
  transition: transform 0.3s ease, opacity 0.3s ease;
}

/* --- ç¸¦æ›¸ãã‚«ãƒ©ãƒ è¨­å®š --- */
.col {  
  writing-mode: vertical-rl; text-orientation: upright;  
  font-size:1.4rem; line-height:2.2em; letter-spacing:0.1em;  
  text-align:center; position:relative;
  height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;
  font-family:"Yuji Syuku","Shippori Mincho B1",serif;
}
.kami { min-width:2.5em; }

/* --- ä¸‹ã®å¥ã‚¨ãƒªã‚¢ï¼ˆé‡è¦ï¼‰ --- */
.shimo { 
  min-width: 2.5em; 
  flex-direction: row; 
  align-items: center;
  will-change: opacity;
  transition: opacity 0.3s ease-in-out;
}

/* --- ãƒã‚¹ã‚¯ï¼ˆæ“¬ä¼¼è¦ç´ ã§ï¼Ÿã‚’è¡¨ç¾ï¼‰ --- */
.full-mask, .hint-mask {
  background: #f8f8f2;
  border: 3px solid #2f5d50;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #2f5d50;
  position: absolute; 
  will-change: opacity;
  transition: opacity 0.2s ease-out; 
}
.full-mask {
  width: 100%; 
  height: 100%; 
  top: 0; left: 0;
}
.full-mask::after {
  content: '?';
  font-size: 2.5rem; 
  font-weight: bold;
  writing-mode: horizontal-tb;
  text-orientation: mixed;
  font-family: Arial, sans-serif;
  line-height: 1;
}
.hint-mask {
  width: 2.5em;
  height: 6em; 
  margin-top: 0.5em; 
  position: static; 
}
.hint-mask::after {
  content: '?';
  font-size: 1.8rem;
  font-weight: bold;
  writing-mode: horizontal-tb;
  text-orientation: mixed;
  font-family: Arial, sans-serif;
  line-height: 1;
}
.fade-out {
  opacity: 0 !important;
  pointer-events: none; 
}
.col.shimo > span {
    font-family:"Yuji Syuku","Shippori Mincho B1",serif;
}

/* --- UIãƒ‘ãƒ¼ãƒ„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ --- */
.card.slide-in-left { animation: slideInLeft 0.3s forwards; }.card.slide-in-right { animation: slideInRight 0.3s forwards; }
@keyframes slideInLeft { from { transform: translateX(-100%); opacity:0; } to { transform: translateX(0); opacity:1; } }
@keyframes slideInRight { from { transform: translateX(100%); opacity:0; } to { transform: translateX(0); opacity:1; } }

/* ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.hint-btn { 
  position: absolute; top: 12px; left: 12px; z-index: 3; 
  background: rgba(224, 172, 76, 0.9); 
  color: white; border: none; 
  border-radius: 6px; 
  padding: 6px 12px; 
  font-size: 0.9rem; 
  white-space: nowrap; 
  cursor: pointer; box-shadow: 2px 2px 4px rgba(0,0,0,0.2); 
  display: flex; align-items: center; justify-content: center; 
  /* â˜…ä¿®æ­£: ã‚¿ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã® transition ã®èª¿æ•´ */
  transition: background 0.2s, transform 0.1s, opacity 0.2s ease-out; 
}
/* â˜…ä¿®æ­£: ã‚¿ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (scale 0.95 ã¯ã™ã§ã«è¨­å®šæ¸ˆã¿) */
.hint-btn:active { background: rgba(190, 140, 50, 0.9); transform: scale(0.95); }
.hint-btn.fade-out { opacity: 0; pointer-events: none; }
.hint-btn img { 
    width: 85%; 
    height: 85%; 
    object-fit: contain; 
    filter: invert(100%) brightness(100%); 
}

/* --- ã‚¨ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
#errorBox {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%) translateY(-100%); 
    background: rgba(220, 50, 50, 0.95); 
    color: white;
    padding: 12px 20px;
    border-radius: 0 0 8px 8px; 
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    z-index: 1000; 
    font-size: 1rem;
    font-weight: bold;
    text-align: center;
    max-width: 90%;
    /* â˜…ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚´ã‚·ãƒƒã‚¯ä½“ã«ã™ã‚‹ */
    font-family: Arial, "Helvetica Neue", Helvetica, "Noto Sans JP", sans-serif;
    transition: transform 0.4s ease-out, opacity 0.4s ease-out;
}
#errorBox.show {
    transform: translateX(-50%) translateY(0); 
}

/* --- è¨­å®š/ä½¿ã„æ–¹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ --- */
.settings-overlay {  
  position:fixed; inset:0; 
  background: rgba(255,255,240,0.95) url('washi-texture.png') center/cover;  
  display:none; justify-content:center; align-items:center; 
  z-index: 1010; 
  opacity: 0; 
  transition: opacity 0.2s ease-in-out; 
  overflow-y: auto; 
}
.settings-overlay.show {
  opacity: 1;
  display: flex;
}

/* --- ãã®ä»–UIãƒ‘ãƒ¼ãƒ„ï¼ˆå¤‰æ›´ãªã—ï¼‰ --- */
.author {  position:absolute; bottom:16px; left:16px;  writing-mode: vertical-rl; text-orientation: upright;  font-size:1rem; color:#444;}
.number {  position:absolute; top:12px; right:16px;  font-size:1.2rem; font-weight:bold; color:#333;}
.settings-btn, .help-btn {  position:absolute; top:12px;  background: rgba(47,93,80,0.9); color:white; border:none;  border-radius:6px; padding:6px 12px; cursor:pointer; font-size:0.9rem;  white-space: nowrap;}.settings-btn { right:120px; }.help-btn { right:12px; }
.settings-box {  background:#fffef8; border:4px solid #2f5d50; border-radius:12px;  padding:24px; width:min(90%,400px);  box-shadow:6px 8px 18px rgba(0,0,0,0.35); font-size:1rem;}
.settings-box h2 {  margin-top:0; font-size:1.2rem;  border-bottom:2px solid #2f5d50; padding-bottom:6px; margin-bottom:12px;}
.range-container { display:flex; align-items:center; gap:6px; margin-bottom:12px; }.range-label { font-weight:bold; }.range-input {  width:50px; border:2px solid #2f5d50; border-radius:8px;  padding:4px 6px; text-align:center;  font-family:"Shippori Mincho B1","Noto Serif JP",serif;  background: linear-gradient(to bottom,#fffef8,#fdf6e3);  font-size:1rem;}.tilde { font-weight:bold; }
.switch-container {  display:flex; align-items:center; justify-content:space-between;  margin-bottom:12px; font-size:1rem;}.switch { position:relative; display:inline-block; width:60px; height:26px; vertical-align:middle; }.switch input { opacity:0; width:0; height:0; }.slider {  position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;  background:#f1e5c4; border:2px solid #2f5d50; border-radius:26px; transition:0.4s;}.slider:before {  position:absolute; content:""; height:20px; width:20px;  top:50%; transform:translateY(-50%); left:3px;  background:#2f5d50; border-radius:50%; transition:0.4s;}.switch input:checked + .slider { background:#d0a95b; }.switch input:checked + .slider:before { transform: translate(32px,-50%); }
.settings-actions { text-align:right; margin-top:12px; }.settings-actions button {  background:#2f5d50; color:white; border:none;  padding:6px 14px; border-radius:6px; cursor:pointer;}
@media(max-width:600px){  .container { gap:8px; }  .nav-btn { width:40px; height:40px; font-size:1.2rem; }  .settings-btn, .help-btn { padding:4px 8px; font-size:0.8rem; }}
#helpBox a {  color: #2f5d50;  text-decoration: underline;}#helpBox a:hover {  color: #2f5d50;  text-decoration: underline;}
#homeBtn {  position: fixed;  bottom: 0; right: 0; width: 70px; height: 70px; z-index: 30; display: flex; align-items: center; justify-content: center; background: rgba(47,93,80,0.9); border-top-left-radius: 12px; box-shadow: -2px -2px 6px rgba(0,0,0,0.3); cursor: pointer; transition: background 0.2s; padding: 8px; }#homeBtn:hover {  background: rgba(30,60,50,0.9);}#homeBtn img {  width: 100%;  height: 100%;  object-fit: contain; }  
/* â˜…è¿½åŠ : ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#testErrorBtn {
    position: fixed;
    bottom: 80px; 
    right: 10px;
    padding: 8px 12px;
    background: #505050;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    z-index: 50;
    cursor: pointer;
    transition: background 0.2s;
}
#testErrorBtn:active {
    background: #303030;
}
</style>
</head><body>

<div id="errorBox"></div>

<button class="settings-btn" id="settingsBtn" aria-label="è¨­å®š">è¨­å®š</button><button class="help-btn" id="helpBtn" aria-label="ä½¿ã„æ–¹">ä½¿ã„æ–¹</button>
<div class="settings-overlay" id="settingsOverlay">  <div class="settings-box" id="settingsBox">    <h2>è¨­å®š</h2>    <div class="range-container">      <span class="range-label">ç¯„å›²:</span>      <input type="number" id="rangeStart" min="1" max="100" value="1" class="range-input">      <span class="tilde">ã€œ</span>      <input type="number" id="rangeEnd" min="1" max="100" value="100" class="range-input">    </div>    <div class="switch-container">      <span>ãƒ©ãƒ³ãƒ€ãƒ ã«ã™ã‚‹</span>      <label class="switch">        <input type="checkbox" id="randomMode">        <span class="slider"></span>      </label>    </div>    <div class="settings-actions"><button id="applySettings">OK</button></div>  </div></div>
<div class="settings-overlay" id="helpOverlay">  <div class="settings-box" id="helpBox">    <h2>ä½¿ã„æ–¹</h2>    <p>çŸ¢å°ã¾ãŸã¯ãƒœã‚¿ãƒ³ã§ã‚«ãƒ¼ãƒ‰åˆ‡æ›¿ã€‚</p>    <p>ãƒã‚¹ã‚¯ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ä¸‹ã®å¥ã¨ä½œè€…ãŒè¡¨ç¤ºã€‚</p>
    <p>ãƒ’ãƒ³ãƒˆ<span class="hint-img-inline">ğŸ’¡</span>ãƒœã‚¿ãƒ³ã§ä¸€æ–‡å­—ãƒ’ãƒ³ãƒˆã€‚ãƒã‚¹ã‚¯ã‚’ã‚¿ãƒƒãƒ—ã§ç­”ãˆè¡¨ç¤ºã€‚</p>
    <p>è¨­å®šã§ç¯„å›²ã‚„ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºå¯èƒ½ã€‚</p>    <a href="use/">â–·æ“ä½œæ–¹æ³•</a><br>    <a href="add-app/">â–·ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¿½åŠ æ–¹æ³•</a><br>    <a href="news/">â–·ãŠçŸ¥ã‚‰ã›</a><br>    <a href="terms-of-service/">â–·åˆ©ç”¨è¦ç´„</a><br>    <div class="settings-actions"><button id="closeHelp">OK</button></div>  </div></div>
<div class="container">
  <button class="nav-btn" id="prevBtn" aria-label="å‰ã®ã‚«ãƒ¼ãƒ‰">â—€</button>
  <div class="card" id="card">
    <div id="kami" class="col kami"></div>
    <div class="col shimo" id="shimoCol">
      </div>
    <div id="author" class="author"></div>
    <div id="number" class="number"></div>
    <button class="hint-btn" id="hintBtn" aria-label="ãƒ’ãƒ³ãƒˆ">
        ãƒ’ãƒ³ãƒˆ
    </button>
  </div>
  <button class="nav-btn" id="nextBtn" aria-label="æ¬¡ã®ã‚«ãƒ¼ãƒ‰">â–¶</button>
</div>
<a href="https://symphony100.github.io/symphony/study/" id="homeBtn" aria-label="ãƒ›ãƒ¼ãƒ " title="ãƒ›ãƒ¼ãƒ ">  <img src="home-icon.png" alt="ãƒ›ãƒ¼ãƒ " /></a>

<script>
// --- å¤‰æ•° ---
let allCards = [];
let remainingCards = [], currentCard = null, hintState = 0; 

// --- DOMè¦ç´  ---
const kamiEl = document.getElementById("kami"),      
      shimoCol = document.getElementById("shimoCol"),
      authorEl = document.getElementById("author"),      
      numberEl = document.getElementById("number"),      
      cardEl = document.getElementById("card"),      
      prevBtn = document.getElementById("prevBtn"),      
      nextBtn = document.getElementById("nextBtn"),
      hintBtn = document.getElementById("hintBtn"),
      settingsOverlay = document.getElementById("settingsOverlay"),
      helpOverlay = document.getElementById("helpOverlay"),
      settingsBox = document.getElementById("settingsBox"),
      applySettingsBtn = document.getElementById("applySettings"),
      rangeStartEl = document.getElementById("rangeStart"),
      rangeEndEl = document.getElementById("rangeEnd"),
      randomModeEl = document.getElementById("randomMode"),
      errorBox = document.getElementById("errorBox");

// PNGç”»åƒã¸ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆ/çµµæ–‡å­—å¯¾å¿œã«ä¿®æ­£ï¼‰
function insertHelpTextForHint() {
    const hintTextContainer = document.querySelector('.hint-img-inline');
    if (hintTextContainer) {
        hintTextContainer.textContent = 'ğŸ’¡'; 
    }
}
window.addEventListener("load", insertHelpTextForHint);

// --- ç”»é¢å…¨ä½“ã®ã‚¿ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ---
function tapAnimation(e) {
    // ãƒœã‚¿ãƒ³ã‚„ãƒªãƒ³ã‚¯ãªã©ã€ç‰¹å®šè¦ç´ ã‹ã‚‰ã®ã‚¿ãƒƒãƒ—ã¯é™¤å¤–
    if (e.target.closest('button, a, input, .settings-box, .card')) return;

    document.body.classList.add('tapped');
    setTimeout(() => {
        document.body.classList.remove('tapped');
    }, 100); 
}
document.body.addEventListener('touchstart', tapAnimation, { passive: true });


// --- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºé–¢æ•° ---
let errorTimeout;
function showError(message) {
    clearTimeout(errorTimeout);
    
    errorBox.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + message;
    errorBox.classList.add("show");
    
    // 5ç§’å¾Œã«æ¶ˆã™
    errorTimeout = setTimeout(() => {
        errorBox.classList.remove("show");
    }, 5000);
}


// --- å‡¦ç† ---
async function loadCards() {
  try {    
    const res = await fetch("https://symphony100.github.io/symphony/study/karuta/cards.json");    
    if (!res.ok) {
        throw new Error('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
    allCards = await res.json();    
    loadSettings();    
    applySettings();  
  } catch (e) {    
    let errorMessage = e.message || "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚";
    console.error("èª­ã¿è¾¼ã¿å¤±æ•—:", errorMessage);
    
    showError('ç™¾äººä¸€é¦–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (' + errorMessage + ')'); 
    
    kamiEl.textContent = "ç™¾äººä¸€é¦–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    shimoCol.innerHTML = "";
    numberEl.textContent = "";
    authorEl.textContent = "";
    hintBtn.style.display = "none";
  }
}

function loadSettings(){
  const saved = localStorage.getItem("karutaSettings");  
  if(saved){    
    try {      
      const s = JSON.parse(saved);      
      if(s.rangeStart) rangeStartEl.value = s.rangeStart;      
      if(s.rangeEnd)   rangeEndEl.value   = s.rangeEnd;      
      if(typeof s.randomMode === "boolean") randomModeEl.checked = s.randomMode;    
    } catch(e){}  
  }
}
function saveSettings(start,end,random){
  localStorage.setItem("karutaSettings", JSON.stringify({ rangeStart: start, rangeEnd: end, randomMode: random }));
}

function adjustFontSize(el){
  let fontSize=1.4;  
  el.style.fontSize=fontSize+"rem";  
  while(el.scrollHeight > el.clientHeight && fontSize > 0.8){    
    fontSize-=0.05;    
    el.style.fontSize=fontSize+"rem";  
  }
}

function renderCard(card, direction="right"){
  currentCard = card;
  hintState = 0;
  
  // ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
  kamiEl.style.fontSize=""; kamiEl.style.width=""; kamiEl.style.textAlign="";
  cardEl.classList.remove("slide-in-left","slide-in-right");
  void cardEl.offsetWidth;
  cardEl.classList.add(direction==="right"?"slide-in-right":"slide-in-left");
  
  kamiEl.textContent = card.kami;
  adjustFontSize(kamiEl);
  numberEl.textContent = card.id;
  authorEl.textContent = "";
  
  // ä¸‹ã®å¥ã‚¨ãƒªã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
  shimoCol.innerHTML = ""; 
  shimoCol.style.opacity = '1'; 
  
  // å…¨ä½“ãƒã‚¹ã‚¯è¦ç´ ã‚’ä½œæˆ
  const maskDiv = document.createElement("div");
  maskDiv.className = "full-mask";
  maskDiv.onclick = show; 
  shimoCol.appendChild(maskDiv); 

  hintBtn.classList.remove("fade-out"); 
  hintBtn.style.display = "flex"; 
  prevBtn.style.display="flex";
  nextBtn.style.display="flex";
}

// ç­”ãˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° 
function show(){ 
  if(hintState === 2) return;
  
  const currentMask = shimoCol.querySelector('.full-mask, .hint-mask');
  
  // 1. ãƒã‚¹ã‚¯ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã•ã›ã‚‹
  if (currentMask) {
    currentMask.classList.add("fade-out");
  }
  
  // 2. ä¸‹ã®å¥ã‚’ãµã‚ã£ã¨è¡¨ç¤ºã™ã‚‹
  shimoCol.style.opacity = '0'; 
  setTimeout(() => {
    // ShimoColã‚’ç­”ãˆã®ãƒ†ã‚­ã‚¹ãƒˆã«æ›¸ãæ›ãˆ
    shimoCol.innerHTML = ""; 
    const textNode = document.createTextNode(currentCard.shimo);
    shimoCol.appendChild(textNode);
    shimoCol.style.opacity = '1'; // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
  }, 200); 

  authorEl.textContent = currentCard.author; 
  hintState = 2; 
  hintBtn.classList.add("fade-out"); // ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
  setTimeout(() => {
    hintBtn.style.display = "none";
  }, 200); 
}

// ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° 
function showFirstCharHint(){
  if(hintState !== 0) return;
  
  const firstChar = currentCard.shimo.charAt(0);
  
  // ãƒã‚¹ã‚¯ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
  const fullMask = shimoCol.querySelector('.full-mask');
  if (fullMask) {
    fullMask.classList.add("fade-out");
  }

  // DOMã‚’æ›¸ãæ›ãˆï¼šã€Œä¸€æ–‡å­—ç›®ã€ï¼‹ã€Œãƒ’ãƒ³ãƒˆãƒã‚¹ã‚¯ã€ã«ã™ã‚‹
  shimoCol.innerHTML = ""; // ã‚¯ãƒªã‚¢
  
  // 1. ä¸€æ–‡å­—ç›® (spanã§ãƒ•ã‚©ãƒ³ãƒˆã‚’ç¢ºå®Ÿã«é©ç”¨)
  const charSpan = document.createElement("span");
  charSpan.textContent = firstChar;
  shimoCol.appendChild(charSpan);
  
  // 2. ãƒ’ãƒ³ãƒˆãƒã‚¹ã‚¯ (å››è§’)
  const hintDiv = document.createElement("div");
  hintDiv.className = "hint-mask";
  hintDiv.onclick = show;
  shimoCol.appendChild(hintDiv);
  
  // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ãŸãƒ•ãƒ«ãƒã‚¹ã‚¯ã‚’DOMã‹ã‚‰å‰Šé™¤ (200mså¾Œã«)
  setTimeout(() => {
    if(fullMask && fullMask.parentNode) fullMask.parentNode.removeChild(fullMask);
  }, 200); 

  hintState = 1; 
  // â˜…ä¿®æ­£: ãƒ’ãƒ³ãƒˆè¡¨ç¤ºå¾Œã€ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
  hintBtn.style.display = "none"; 
}

hintBtn.addEventListener("click", () => {
    if(currentCard && hintState === 0) showFirstCharHint();
});

// æ¬¡ã¸ãƒ»å‰ã¸
function nextCard(){ 
  if(hintState !== 2 && currentCard){ show(); return; } 
  if(remainingCards.length===0){
    // çµ‚äº†å‡¦ç†
    kamiEl.textContent="ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼";
    shimoCol.innerHTML = "";
    numberEl.textContent=""; authorEl.textContent="";
    hintBtn.style.display="none"; prevBtn.style.display="none"; nextBtn.style.display="none";
    if(!document.getElementById("restartBtn")){
      const btn=document.createElement("button");
      btn.id="restartBtn";
      btn.textContent="ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤";
      btn.style.marginTop="20px"; btn.style.padding="8px 16px"; btn.style.background="#2f5d50"; btn.style.color="white"; btn.style.border="none"; btn.style.borderRadius="6px"; btn.style.cursor="pointer";
      btn.addEventListener("click",()=>{ applySettings(); btn.remove(); });
      cardEl.appendChild(btn);
    }
  } else {
    renderCard(remainingCards.shift(),"right");
  }
}

function prevCard(){  
  if(!randomModeEl.checked && currentCard){
    let idx = allCards.findIndex(c=>c.id===currentCard.id);
    let prevIdx = (idx-1+allCards.length)%allCards.length;
    renderCard(allCards[prevIdx],"left");
  }
}

// ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºé–¢æ•°
function showOverlay(overlayEl) {
    overlayEl.style.display = "flex";
    setTimeout(() => {
        overlayEl.classList.add("show");
    }, 10);
}
// ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤éè¡¨ç¤ºé–¢æ•° 
function hideOverlay(overlayEl) {
    overlayEl.classList.remove("show");
    setTimeout(() => {
        overlayEl.style.display = "none";
    }, 200); 
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.addEventListener("keydown",e=>{ if(e.key==="ArrowRight"||e.key==="ArrowDown") nextCard(); else if(e.key==="ArrowLeft"||e.key==="ArrowUp") prevCard(); });
prevBtn.addEventListener("click",prevCard);
nextBtn.addEventListener("click",nextCard);
document.getElementById("settingsBtn").addEventListener("click",()=>{ showOverlay(settingsOverlay); });
applySettingsBtn.addEventListener("click",applySettings);
settingsOverlay.addEventListener("click",e=>{ 
    const settingsBox = document.getElementById("settingsBox");
    if (e.target.id === 'settingsOverlay' || (e.target.parentElement && e.target.parentElement.id === 'settingsOverlay')) {
        hideOverlay(settingsOverlay); 
    }
});
document.getElementById("helpBtn").addEventListener("click",()=>{ showOverlay(helpOverlay); });
document.getElementById("closeHelp").addEventListener("click",()=>{ hideOverlay(helpOverlay); });
document.getElementById("helpOverlay").addEventListener("click",e=>{ 
    const helpBox = document.getElementById("helpBox");
    if (e.target.id === 'helpOverlay' || (e.target.parentElement && e.target.parentElement.id === 'helpOverlay')) {
        hideOverlay(helpOverlay);
    }
});

function applySettings(){  
  if(allCards.length === 0) {
    showError("ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ãŸã‚ã€è¨­å®šã‚’é©ç”¨ã§ãã¾ã›ã‚“ã€‚"); 
    hideOverlay(settingsOverlay);
    return;
  }
  
  let start=parseInt(rangeStartEl.value,10), end=parseInt(rangeEndEl.value,10);
  if(start<1) start=1; if(end>allCards.length) end=allCards.length; if(start>end) [start,end]=[end,start];
  saveSettings(start,end,randomModeEl.checked);
  remainingCards = allCards.slice(start-1,end); 
  if(randomModeEl.checked) remainingCards = shuffle(remainingCards);
  
  // å†é–‹ãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°æ¶ˆã™
  const rb = document.getElementById("restartBtn"); if(rb) rb.remove();
  
  // â˜…ä¿®æ­£: ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°æ¶ˆã™
  const testBtn = document.getElementById("testErrorBtn"); if(testBtn) testBtn.remove();
  
  renderCard(remainingCards.shift(),"right");  
  hideOverlay(settingsOverlay);
}

function shuffle(array){  
  let arr=array.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr;
}

// ã‚¿ãƒƒãƒæ“ä½œ
let touchStartX=0;
cardEl.addEventListener("touchstart",e=>{ touchStartX=e.touches[0].clientX; });
cardEl.addEventListener("touchend",e=>{  
  let touchEndX=e.changedTouches[0].clientX;  
  if(touchEndX-touchStartX>50) prevCard(); else if(touchStartX-touchEndX>50) nextCard();
});
document.addEventListener('touchstart',function(e){ 
    if(e.touches.length > 2) return; 
},{passive:false});
// ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã«ã‚ˆã‚‹æ‹¡å¤§ã®ã¿ç¦æ­¢ã‚’ç¶­æŒ
document.addEventListener('dblclick',function(e){ e.preventDefault(); },{passive:false});

// --- ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ã‚³ãƒ¼ãƒ‰ã§ç°¡å˜ã«æ¶ˆã›ã‚‹ã‚ˆã†ã«ã€ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã«è¨˜è¿°) ---
/*
document.getElementById("testErrorBtn").addEventListener("click", () => {
    // ç™ºç”Ÿã•ã›ã‚‹ã‚¨ãƒ©ãƒ¼ã®ä¾‹
    showError("ãƒ†ã‚¹ãƒˆç”¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
});
*/

// åˆæœŸå®Ÿè¡Œ
window.addEventListener("load", loadCards);
</script></body></html>
